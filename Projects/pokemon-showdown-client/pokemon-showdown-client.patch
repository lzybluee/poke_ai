From 7ab26d74e0add11334513ca5cad9a2a96e3b1f17 Mon Sep 17 00:00:00 2001
From: lzybluee <lzybluee@gmail.com>
Date: Sat, 18 Oct 2025 07:42:00 +0800
Subject: [PATCH] Patch

---
 build-tools/update                            |  4 +-
 package.json                                  |  1 +
 play.pokemonshowdown.com/js/client-battle.js  | 49 +++++++++++++++++
 .../src/battle-animations-moves.ts            | 54 +++++++++----------
 .../src/battle-animations.ts                  |  6 +--
 play.pokemonshowdown.com/src/battle-dex.ts    | 13 ++---
 .../src/battle-searchresults.tsx              |  6 +--
 play.pokemonshowdown.com/src/battle-sound.ts  |  2 +-
 play.pokemonshowdown.com/src/panels.tsx       |  2 +-
 play.pokemonshowdown.com/style/battle.css     |  3 ++
 play.pokemonshowdown.com/style/client.css     | 10 ++--
 play.pokemonshowdown.com/style/client2.css    | 10 ++--
 play.pokemonshowdown.com/testclient.html      |  3 +-
 teams.pokemonshowdown.com/src/utils.tsx       |  2 +-
 14 files changed, 106 insertions(+), 59 deletions(-)

diff --git a/build-tools/update b/build-tools/update
index 18733bcd..a0df12df 100755
--- a/build-tools/update
+++ b/build-tools/update
@@ -203,7 +203,7 @@ try {
 		stdio: 'pipe',
 	});
 } catch (e) {
-	console.log("git hook failed to retrieve news (exec command failed):\n" + (e.error + e.stderr + e.stdout));
+	//console.log("git hook failed to retrieve news (exec command failed):\n" + (e.error + e.stderr + e.stdout));
 }
 try {
 	if (stdout) [newsid, news] = JSON.parse(stdout);
@@ -211,7 +211,7 @@ try {
 	if (stdout.includes("config/news.inc.php): Failed to open stream: No such file or directory")) {
 		console.log("news.inc.php unavailable");
 	} else {
-		console.log("git hook failed to retrieve news (parsing JSON failed):\n\n" + e.message + '\n\n' + stdout);
+		//console.log("git hook failed to retrieve news (parsing JSON failed):\n\n" + e.message + '\n\n' + stdout);
 	}
 }
 
diff --git a/package.json b/package.json
index 125655fb..14f95d99 100644
--- a/package.json
+++ b/package.json
@@ -23,6 +23,7 @@
     "@babel/preset-typescript": "^7.27.0",
     "babel-plugin-remove-import-export": "^1.1.1",
     "google-auth-library": "^3.1.2",
+    "http-server": "^14.1.1",
     "image-size": "^0.7.5"
   },
   "devDependencies": {
diff --git a/play.pokemonshowdown.com/js/client-battle.js b/play.pokemonshowdown.com/js/client-battle.js
index c20b220d..70efb8e3 100644
--- a/play.pokemonshowdown.com/js/client-battle.js
+++ b/play.pokemonshowdown.com/js/client-battle.js
@@ -10,6 +10,7 @@
 			this.choice = undefined;
 			/** are move/switch/team-preview controls currently being shown? */
 			this.controlsShown = false;
+			this.speed = 'normal';
 
 			this.battlePaused = false;
 			this.autoTimerActivated = false;
@@ -266,6 +267,54 @@
 			var switchViewpointButton = '<p><button class="button" name="switchViewpoint"><i class="fa fa-random"></i> Switch viewpoint</button></p>';
 			this.controlsShown = false;
 
+			var speedTable = {
+				hyperfast: 'Hyperfast',
+				fast: 'Fast',
+				normal: 'Normal',
+				slow: 'Slow',
+				reallyslow: 'Really Slow'
+			};
+
+			switchViewpointButton += '<div class="chooser leftchooser speedchooser"><em>Speed:</em><div>';
+			for (speed in speedTable) {
+				if (speedTable.hasOwnProperty(speed)) {
+					if (speed == this.speed)
+						switchViewpointButton += '<button value="' + speed + '" class="sel">' + speedTable[speed] + '</button>';
+					else
+						switchViewpointButton += '<button value="' + speed + '">' + speedTable[speed] + '</button>';
+				}
+			}
+			switchViewpointButton += '</div></div>';
+
+			var self = this;
+			this.$el.on('click', '.chooser button', function (e) {
+				self.speed = e.currentTarget.value
+				var $chooser = $(e.currentTarget).closest('.chooser');
+				var valueElem = $chooser.find('button[value=' + self.speed + ']');
+				$chooser.find('button').removeClass('sel');
+				valueElem.addClass('sel');
+
+				var delayTable = {
+					hyperfast: 1,
+					fast: 1,
+					normal: 1,
+					slow: 1000,
+					reallyslow: 3000
+				};
+				var fadeTable = {
+					hyperfast: 40,
+					fast: 50,
+					normal: 300,
+					slow: 500,
+					reallyslow: 1000
+				};
+
+				console.log(self.speed)
+				self.battle.messageShownTime = delayTable[self.speed];
+				self.battle.messageFadeTime = fadeTable[self.speed];
+				self.battle.scene.updateAcceleration();
+			});
+
 			if (this.battle.seeking !== null) {
 
 				// battle is seeking
diff --git a/play.pokemonshowdown.com/src/battle-animations-moves.ts b/play.pokemonshowdown.com/src/battle-animations-moves.ts
index cdae57c2..59b02888 100644
--- a/play.pokemonshowdown.com/src/battle-animations-moves.ts
+++ b/play.pokemonshowdown.com/src/battle-animations-moves.ts
@@ -712,7 +712,7 @@ export const BattleMoveAnims: AnimTable = {
 					time: 1550,
 				}, 'decel');
 			}
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-hail.png')`, 750, 1, 800);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-hail.png')`, 750, 1, 800);
 		},
 	},
 	sandstorm: {
@@ -1534,7 +1534,7 @@ export const BattleMoveAnims: AnimTable = {
 	orderup: {
 		anim(scene, [attacker, defender]) {
 			const tatsugiriSprite = {
-				url: `https://${Config.routes.client}/sprites/gen5/tatsugiri${['-droopy', '-stretchy', ''][Math.floor(Math.random() * 3)]}.png`,
+				url: `http://${window.location.host}/play.pokemonshowdown.com/sprites/gen5/tatsugiri${['-droopy', '-stretchy', ''][Math.floor(Math.random() * 3)]}.png`,
 				w: 96,
 				h: 96,
 			};
@@ -3611,7 +3611,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	morningsun: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sunnyday.jpg')`, 700, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sunnyday.jpg')`, 700, 0.5);
 			scene.showEffect('wisp', {
 				x: attacker.x + 40,
 				y: attacker.y - 40,
@@ -3664,7 +3664,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	moonlight: {
 		anim(scene, [attacker]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 800, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 800, 0.6);
 			scene.showEffect('moon', {
 				x: attacker.x,
 				y: attacker.y + 150,
@@ -3748,7 +3748,7 @@ export const BattleMoveAnims: AnimTable = {
 	lunarblessing: {
 		anim(scene, [attacker, ...defenders]) {
 			for (const defender of defenders) {
-				scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 900, 0.6);
+				scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 900, 0.6);
 				scene.showEffect('moon', {
 					x: attacker.x,
 					y: attacker.y + 150,
@@ -3872,7 +3872,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	cosmicpower: {
 		anim(scene, [attacker]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 600, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 600, 0.6);
 			scene.showEffect('wisp', {
 				x: attacker.x + 40,
 				y: attacker.y - 40,
@@ -5755,7 +5755,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	seismictoss: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 500, 0.6, 300);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 500, 0.6, 300);
 			scene.showEffect('wisp', {
 				x: defender.x,
 				y: defender.y + 10,
@@ -8587,7 +8587,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	meteormash: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 1000, 0.4);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 1000, 0.4);
 			scene.showEffect(attacker.sp, {
 				x: attacker.leftof(20),
 				y: attacker.y,
@@ -19199,7 +19199,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	psystrike: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-psychicterrain.png')`, 950, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-psychicterrain.png')`, 950, 0.6);
 			scene.showEffect('poisonwisp', {
 				x: defender.x - 100,
 				y: defender.y,
@@ -20061,7 +20061,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	moonblast: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 800, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 800, 0.6);
 			scene.showEffect('moon', {
 				x: attacker.x,
 				y: attacker.y,
@@ -20366,7 +20366,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	wish: {
 		anim(scene, [attacker]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 600, 0.4);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 600, 0.4);
 
 			scene.showEffect('wisp', {
 				x: attacker.x,
@@ -20380,7 +20380,7 @@ export const BattleMoveAnims: AnimTable = {
 			}, 'accel');
 		},
 		residualAnim(scene, [attacker]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 600, 0.4);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 600, 0.4);
 
 			scene.showEffect('wisp', {
 				x: attacker.x,
@@ -21629,7 +21629,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	dracometeor: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 1100, 0.8);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 1100, 0.8);
 			scene.showEffect('flareball', {
 				x: defender.leftof(-200),
 				y: defender.y + 175,
@@ -23143,7 +23143,7 @@ export const BattleMoveAnims: AnimTable = {
 			let ystep = (defender.x - 200 - attacker.x) / 5;
 			let zstep = (defender.z - attacker.z) / 5;
 
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sunnyday.jpg')`, 900, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sunnyday.jpg')`, 900, 0.5);
 
 			for (let i = 0; i < 5; i++) {
 				scene.showEffect('energyball', {
@@ -23502,7 +23502,7 @@ export const BattleMoveAnims: AnimTable = {
 			let ystep = 20;
 			let zstep = 0;
 
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sunnyday.jpg')`, 900, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sunnyday.jpg')`, 900, 0.5);
 
 			scene.showEffect('sword', {
 				x: attacker.leftof(10),
@@ -23787,7 +23787,7 @@ export const BattleMoveAnims: AnimTable = {
 			let ystep = (defender.x - 200 - attacker.x) / 5;
 			let zstep = (defender.z - attacker.z) / 5;
 
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sandstorm.png')`, 900, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sandstorm.png')`, 900, 0.5);
 
 			for (let i = 0; i < 5; i++) {
 				scene.showEffect('mudwisp', {
@@ -23987,7 +23987,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	sheercold: { // Reminder: Improve this later
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-icecave.jpg')`, 1000, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-icecave.jpg')`, 1000, 0.6);
 			scene.showEffect('icicle', {
 				x: defender.x,
 				y: defender.y,
@@ -24005,7 +24005,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	glaciallance: {
 		anim(scene, [attacker, ...defenders]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-icecave.jpg')`, 1000, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-icecave.jpg')`, 1000, 0.6);
 			for (const defender of defenders) {
 				scene.showEffect('icicle', {
 					x: defender.x,
@@ -26320,7 +26320,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	dragonascent: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 1000, 0.7);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 1000, 0.7);
 			scene.showEffect('iceball', {
 				x: attacker.leftof(-25),
 				y: attacker.y + 250,
@@ -29811,7 +29811,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	plasmafists: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-earthycave.jpg')`, 2000, 1);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-earthycave.jpg')`, 2000, 1);
 			scene.backgroundEffect('#000000', 1000, 0.6);
 			scene.backgroundEffect('#FFFFFF', 300, 0.6, 1000);
 			scene.showEffect('electroball', {
@@ -30054,7 +30054,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	collisioncourse: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sunnyday.jpg')`, 1300, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sunnyday.jpg')`, 1300, 0.5);
 			scene.showEffect(attacker.sp, {
 				x: attacker.x,
 				y: attacker.y,
@@ -30200,7 +30200,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	electrodrift: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-electricterrain.png')`, 1300, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-electricterrain.png')`, 1300, 0.5);
 			scene.showEffect(attacker.sp, {
 				x: attacker.x,
 				y: attacker.y,
@@ -34223,7 +34223,7 @@ export const BattleMoveAnims: AnimTable = {
 	oceanicoperetta: {
 		anim(scene, [attacker, defender]) {
 			scene.backgroundEffect('linear-gradient(#000000 20%, #0000DD)', 2700, 0.4);
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-raindance.jpg')`, 700, 0.2, 2000);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-raindance.jpg')`, 700, 0.2, 2000);
 			scene.showEffect('iceball', {
 				x: attacker.x,
 				y: attacker.y + 120,
@@ -34546,7 +34546,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	splinteredstormshards: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-earthycave.jpg')`, 2700, 0.8, 300);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-earthycave.jpg')`, 2700, 0.8, 300);
 			scene.backgroundEffect('linear-gradient(#FFC720 15%, #421800)', 2700, 0.7);
 			scene.backgroundEffect('#ffffff', 400, 0.6, 2500);
 			scene.showEffect('rock3', {
@@ -35269,7 +35269,7 @@ export const BattleMoveAnims: AnimTable = {
 			}
 			const defender = defenders[1] || defenders[0];
 			scene.backgroundEffect('#000000', 300, 0.9);
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-earthycave.jpg')`, 2000, 0.7, 300);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-earthycave.jpg')`, 2000, 0.7, 300);
 			scene.backgroundEffect('linear-gradient(#FB5C1E 20%, #3F1D0F', 2000, 0.6, 300);
 			scene.backgroundEffect('#FFFFFF', 1000, 0.9, 2200);
 			scene.showEffect('shine', {
@@ -35941,8 +35941,8 @@ export const BattleMoveAnims: AnimTable = {
 			let ystep = (defender.x - 200 - attacker.x) / 5;
 			let zstep = (defender.z - attacker.z) / 5;
 
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-trickroom.png')`, 700, 1);
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 2500, 1, 700);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-trickroom.png')`, 700, 1);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 2500, 1, 700);
 			scene.backgroundEffect('#FFFFFF', 1500, 1, 2500);
 
 			scene.showEffect('flareball', {
diff --git a/play.pokemonshowdown.com/src/battle-animations.ts b/play.pokemonshowdown.com/src/battle-animations.ts
index bf0f29c7..922680a2 100644
--- a/play.pokemonshowdown.com/src/battle-animations.ts
+++ b/play.pokemonshowdown.com/src/battle-animations.ts
@@ -1419,7 +1419,7 @@ export class BattleScene implements BattleSceneStub {
 
 	typeAnim(pokemon: Pokemon, types: string) {
 		const result = BattleLog.escapeHTML(types).split('/').map(type =>
-			`<img src="${Dex.resourcePrefix}sprites/types/${encodeURIComponent(type)}.png" alt="${type}" class="pixelated" />`
+			`<img src="${Dex.resourcePrefix}sprites/types/${encodeURIComponent(type.replace(/\?/g, '-'))}.png" alt="${type}" class="pixelated" />`
 		).join(' ');
 		this.resultAnim(pokemon, result, 'neutral');
 	}
@@ -2842,12 +2842,12 @@ export class PokemonSprite extends Sprite {
 		} else if (pokemon.volatiles.typechange && pokemon.volatiles.typechange[1]) {
 			const types = pokemon.volatiles.typechange[1].split('/');
 			for (const type of types) {
-				status += '<img src="' + Dex.resourcePrefix + 'sprites/types/' + encodeURIComponent(type) + '.png" alt="' + type + '" class="pixelated" /> ';
+				status += '<img src="' + Dex.resourcePrefix + 'sprites/types/' + encodeURIComponent(type.replace(/\?/g, '-')) + '.png" alt="' + type + '" class="pixelated" /> ';
 			}
 		}
 		if (pokemon.volatiles.typeadd) {
 			const type = pokemon.volatiles.typeadd[1];
-			status += '+<img src="' + Dex.resourcePrefix + 'sprites/types/' + type + '.png" alt="' + type + '" class="pixelated" /> ';
+			status += '+<img src="' + Dex.resourcePrefix + 'sprites/types/' + type.replace(/\?/g, '-') + '.png" alt="' + type + '" class="pixelated" /> ';
 		}
 		for (const stat in pokemon.boosts) {
 			if (pokemon.boosts[stat]) {
diff --git a/play.pokemonshowdown.com/src/battle-dex.ts b/play.pokemonshowdown.com/src/battle-dex.ts
index 03910cf4..a4e9bb1e 100644
--- a/play.pokemonshowdown.com/src/battle-dex.ts
+++ b/play.pokemonshowdown.com/src/battle-dex.ts
@@ -229,16 +229,9 @@ export const Dex = new class implements ModdedDex {
 
 	pokeballs: string[] | null = null;
 
-	resourcePrefix = (() => {
-		let prefix = '';
-		if (window.document?.location?.protocol !== 'http:') prefix = 'https:';
-		return `${prefix}//${window.Config ? Config.routes.client : 'play.pokemonshowdown.com'}/`;
-	})();
+	resourcePrefix = `http://${window.location.host}/play.pokemonshowdown.com/`;
 
-	fxPrefix = (() => {
-		const protocol = (window.document?.location?.protocol !== 'http:') ? 'https:' : '';
-		return `${protocol}//${window.Config ? Config.routes.client : 'play.pokemonshowdown.com'}/fx/`;
-	})();
+	fxPrefix = `http://${window.location.host}/play.pokemonshowdown.com/fx/`;
 
 	loadedSpriteData = { xy: 1, bw: 0 };
 	moddedDexes: { [mod: string]: ModdedDex } = {};
@@ -925,7 +918,7 @@ export const Dex = new class implements ModdedDex {
 	getTypeIcon(type: string | null, b?: boolean) { // b is just for utilichart.js
 		type = this.types.get(type).name;
 		if (!type) type = '???';
-		let sanitizedType = type.replace(/\?/g, '%3f');
+		let sanitizedType = type.replace(/\?/g, '-');
 		return `<img src="${Dex.resourcePrefix}sprites/types/${sanitizedType}.png" alt="${type}" height="14" width="32" class="pixelated${b ? ' b' : ''}" />`;
 	}
 
diff --git a/play.pokemonshowdown.com/src/battle-searchresults.tsx b/play.pokemonshowdown.com/src/battle-searchresults.tsx
index 78f4ebc3..0114959d 100644
--- a/play.pokemonshowdown.com/src/battle-searchresults.tsx
+++ b/play.pokemonshowdown.com/src/battle-searchresults.tsx
@@ -100,7 +100,7 @@ export class PSSearchResults extends preact.Component<{
 
 				<span class="col typecol">
 					{pokemon.types.map(type =>
-						<img src={`${Dex.resourcePrefix}sprites/types/${type}.png`} alt={type} height="14" width="32" class="pixelated" />
+						<img src={`${Dex.resourcePrefix}sprites/types/${type.replace(/\?/g, '-')}.png`} alt={type} height="14" width="32" class="pixelated" />
 					)}
 				</span>
 
@@ -250,7 +250,7 @@ export class PSSearchResults extends preact.Component<{
 
 			<span class="col typecol">
 				<img
-					src={`${Dex.resourcePrefix}sprites/types/${encodeURIComponent(move.type)}.png`}
+					src={`${Dex.resourcePrefix}sprites/types/${encodeURIComponent(move.type.replace(/\?/g, '-'))}.png`}
 					alt={move.type} height="14" width="32" class="pixelated"
 				/>
 				<img
@@ -282,7 +282,7 @@ export class PSSearchResults extends preact.Component<{
 
 			<span class="col typecol">
 				<img
-					src={`${Dex.resourcePrefix}sprites/types/${encodeURIComponent(name)}.png`}
+					src={`${Dex.resourcePrefix}sprites/types/${encodeURIComponent(name.replace(/\?/g, '-'))}.png`}
 					alt={name} height="14" width="32" class="pixelated"
 				/>
 			</span>
diff --git a/play.pokemonshowdown.com/src/battle-sound.ts b/play.pokemonshowdown.com/src/battle-sound.ts
index f7104379..cbd85c08 100644
--- a/play.pokemonshowdown.com/src/battle-sound.ts
+++ b/play.pokemonshowdown.com/src/battle-sound.ts
@@ -116,7 +116,7 @@ export const BattleSound = new class {
 		if (this.soundCache[url]) return this.soundCache[url];
 		try {
 			const sound = document.createElement('audio');
-			sound.src = `https://${Config.routes.client}/${url}`;
+			sound.src = `http://${window.location.host}/play.pokemonshowdown.com/` + url;
 			sound.volume = this.effectVolume / 100;
 			this.soundCache[url] = sound;
 			return sound;
diff --git a/play.pokemonshowdown.com/src/panels.tsx b/play.pokemonshowdown.com/src/panels.tsx
index 233fc3e6..2936f541 100644
--- a/play.pokemonshowdown.com/src/panels.tsx
+++ b/play.pokemonshowdown.com/src/panels.tsx
@@ -927,7 +927,7 @@ export function PSIcon(
 	if ('type' in props) {
 		let type = Dex.types.get(props.type).name;
 		if (!type) type = '???';
-		let sanitizedType = type.replace(/\?/g, '%3f');
+		let sanitizedType = type.replace(/\?/g, '-');
 		return <img
 			src={`${Dex.resourcePrefix}sprites/types/${sanitizedType}.png`} alt={type}
 			height="14" width="32" class={`pixelated${props.b ? ' b' : ''}`} style="vertical-align:middle"
diff --git a/play.pokemonshowdown.com/style/battle.css b/play.pokemonshowdown.com/style/battle.css
index bf8bed31..8c792243 100644
--- a/play.pokemonshowdown.com/style/battle.css
+++ b/play.pokemonshowdown.com/style/battle.css
@@ -628,6 +628,7 @@ License: GPLv2
 }
 .leftchooser {
 	float: left;
+	margin: 5px 0 0 10px;
 }
 .chooser em {
 	float: left;
@@ -636,6 +637,7 @@ License: GPLv2
 	border-right: 1px solid #CCCCCC;
 	background: #EEEEEE;
 	font-weight: normal;
+	color: #000000;
 }
 .chooser div {
 	float: left;
@@ -649,6 +651,7 @@ License: GPLv2
 	font-family: Verdana, sans-serif;
 	border-radius: 3px;
 	cursor: pointer;
+	color: #000000;
 }
 .chooser button:hover {
 	border: 1px solid #BBBBBB;
diff --git a/play.pokemonshowdown.com/style/client.css b/play.pokemonshowdown.com/style/client.css
index c14d35c3..4c00d4f1 100644
--- a/play.pokemonshowdown.com/style/client.css
+++ b/play.pokemonshowdown.com/style/client.css
@@ -987,10 +987,10 @@ p.or:after {
 	position: absolute;
 	left: -30px;
 	bottom: -5px;
-	background: url(https://play.pokemonshowdown.com/sprites/gen5/meloetta.png) center no-repeat;
+	background: url(../sprites/gen5/meloetta.png) center no-repeat;
 }
 .roomcounters button:hover .usercount {
-	background: url(https://play.pokemonshowdown.com/sprites/gen5ani/meloetta.gif) center no-repeat;
+	background: url(../sprites/gen5ani/meloetta.gif) center no-repeat;
 }
 .roomcounters .battlecount {
 	display: block;
@@ -999,10 +999,10 @@ p.or:after {
 	position: absolute;
 	right: -30px;
 	bottom: -10px;
-	background: url(https://play.pokemonshowdown.com/sprites/gen5/meloetta-pirouette.png) center no-repeat;
+	background: url(../sprites/gen5/meloetta-pirouette.png) center no-repeat;
 }
 .roomcounters button:hover .battlecount {
-	background: url(https://play.pokemonshowdown.com/sprites/gen5ani/meloetta-pirouette.gif) center no-repeat;
+	background: url(../sprites/gen5ani/meloetta-pirouette.gif) center no-repeat;
 } 
 
 .roomlist {
@@ -3003,7 +3003,7 @@ p.or:after {
 .avatarlist button {
 	width: 80px;
 	height: 80px;
-	background: transparent url(https://play.pokemonshowdown.com/sprites/trainers-sheet.png) no-repeat scroll 0px 0px;
+	background: transparent url(../sprites/trainers-sheet.png) no-repeat scroll 0px 0px;
 }
 .bglist button span {
 	display: block;
diff --git a/play.pokemonshowdown.com/style/client2.css b/play.pokemonshowdown.com/style/client2.css
index 66cdc3fd..e80f009c 100644
--- a/play.pokemonshowdown.com/style/client2.css
+++ b/play.pokemonshowdown.com/style/client2.css
@@ -1068,10 +1068,10 @@ form.menugroup {
 	position: absolute;
 	left: -30px;
 	bottom: -5px;
-	background: url(https://play.pokemonshowdown.com/sprites/gen5/meloetta.png) center no-repeat;
+	background: url(../sprites/gen5/meloetta.png) center no-repeat;
 }
 .roomcounters .button:hover .usercount {
-	background: url(https://play.pokemonshowdown.com/sprites/gen5ani/meloetta.gif) center no-repeat;
+	background: url(../sprites/gen5ani/meloetta.gif) center no-repeat;
 }
 .roomcounters .battlecount {
 	display: block;
@@ -1080,10 +1080,10 @@ form.menugroup {
 	position: absolute;
 	right: -30px;
 	bottom: -10px;
-	background: url(https://play.pokemonshowdown.com/sprites/gen5/meloetta-pirouette.png) center no-repeat;
+	background: url(../sprites/gen5/meloetta-pirouette.png) center no-repeat;
 }
 .roomcounters .button:hover .battlecount {
-	background: url(https://play.pokemonshowdown.com/sprites/gen5ani/meloetta-pirouette.gif) center no-repeat;
+	background: url(../sprites/gen5ani/meloetta-pirouette.gif) center no-repeat;
 } 
 
 .roomlist {
@@ -2229,7 +2229,7 @@ pre.textbox.textbox-empty[placeholder]:before {
 .avatarlist button {
 	width: 80px;
 	height: 80px;
-	background: transparent url(https://play.pokemonshowdown.com/sprites/trainers-sheet.png) no-repeat scroll 0px 0px;
+	background: transparent url(../sprites/trainers-sheet.png) no-repeat scroll 0px 0px;
 }
 .bglist button span {
 	display: block;
diff --git a/play.pokemonshowdown.com/testclient.html b/play.pokemonshowdown.com/testclient.html
index e17d44c0..3539a30b 100644
--- a/play.pokemonshowdown.com/testclient.html
+++ b/play.pokemonshowdown.com/testclient.html
@@ -110,7 +110,8 @@
 		<script src="js/client-battle.js"></script>
 		<script src="js/client-rooms.js"></script>
 		<script src="js/storage.js"></script>
-		<script src="data/graphics.js" onerror="loadRemoteData(this.src)"></script>
+		<script src="js/battle-animations.js"></script>
+		<script src="js/battle-animations-moves.js"></script>
 
 		<script src="data/pokedex.js" onerror="loadRemoteData(this.src)"></script>
 		<script src="data/moves.js" onerror="loadRemoteData(this.src)"></script>
diff --git a/teams.pokemonshowdown.com/src/utils.tsx b/teams.pokemonshowdown.com/src/utils.tsx
index 2fa5181a..752ff7b2 100644
--- a/teams.pokemonshowdown.com/src/utils.tsx
+++ b/teams.pokemonshowdown.com/src/utils.tsx
@@ -218,7 +218,7 @@ export class PSIcon extends preact.Component<{
 		} else if (this.props.type) {
 			let type = Dex.types.get(this.props.type).name;
 			if (!type) type = '???';
-			let sanitizedType = type.replace(/\?/g, '%3f');
+			let sanitizedType = type.replace(/\?/g, '-');
 			return <img
 				src={`${Dex.resourcePrefix}sprites/types/${sanitizedType}.png`}
 				alt={this.props.hideAlt ? undefined : type}
-- 
2.45.1.windows.1

