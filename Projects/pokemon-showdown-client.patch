From 987c3d722dd8bb638036df90bf2cf47e706b717c Mon Sep 17 00:00:00 2001
From: lzybluee <lzybluee@gmail.com>
Date: Sat, 11 Oct 2025 00:14:39 +0800
Subject: [PATCH] Patch

---
 build-tools/update                            |  4 +-
 package.json                                  |  1 +
 play.pokemonshowdown.com/js/client-battle.js  | 49 +++++++++++++++++
 .../src/battle-animations-moves.ts            | 54 +++++++++----------
 .../src/battle-animations.ts                  |  1 +
 play.pokemonshowdown.com/src/battle-dex.ts    | 13 ++---
 play.pokemonshowdown.com/src/battle-sound.ts  |  2 +-
 play.pokemonshowdown.com/style/battle.css     |  2 +
 play.pokemonshowdown.com/testclient.html      |  3 +-
 9 files changed, 88 insertions(+), 41 deletions(-)

diff --git a/build-tools/update b/build-tools/update
index 18733bcd..a0df12df 100755
--- a/build-tools/update
+++ b/build-tools/update
@@ -203,7 +203,7 @@ try {
 		stdio: 'pipe',
 	});
 } catch (e) {
-	console.log("git hook failed to retrieve news (exec command failed):\n" + (e.error + e.stderr + e.stdout));
+	//console.log("git hook failed to retrieve news (exec command failed):\n" + (e.error + e.stderr + e.stdout));
 }
 try {
 	if (stdout) [newsid, news] = JSON.parse(stdout);
@@ -211,7 +211,7 @@ try {
 	if (stdout.includes("config/news.inc.php): Failed to open stream: No such file or directory")) {
 		console.log("news.inc.php unavailable");
 	} else {
-		console.log("git hook failed to retrieve news (parsing JSON failed):\n\n" + e.message + '\n\n' + stdout);
+		//console.log("git hook failed to retrieve news (parsing JSON failed):\n\n" + e.message + '\n\n' + stdout);
 	}
 }
 
diff --git a/package.json b/package.json
index 125655fb..14f95d99 100644
--- a/package.json
+++ b/package.json
@@ -23,6 +23,7 @@
     "@babel/preset-typescript": "^7.27.0",
     "babel-plugin-remove-import-export": "^1.1.1",
     "google-auth-library": "^3.1.2",
+    "http-server": "^14.1.1",
     "image-size": "^0.7.5"
   },
   "devDependencies": {
diff --git a/play.pokemonshowdown.com/js/client-battle.js b/play.pokemonshowdown.com/js/client-battle.js
index c20b220d..70efb8e3 100644
--- a/play.pokemonshowdown.com/js/client-battle.js
+++ b/play.pokemonshowdown.com/js/client-battle.js
@@ -10,6 +10,7 @@
 			this.choice = undefined;
 			/** are move/switch/team-preview controls currently being shown? */
 			this.controlsShown = false;
+			this.speed = 'normal';
 
 			this.battlePaused = false;
 			this.autoTimerActivated = false;
@@ -266,6 +267,54 @@
 			var switchViewpointButton = '<p><button class="button" name="switchViewpoint"><i class="fa fa-random"></i> Switch viewpoint</button></p>';
 			this.controlsShown = false;
 
+			var speedTable = {
+				hyperfast: 'Hyperfast',
+				fast: 'Fast',
+				normal: 'Normal',
+				slow: 'Slow',
+				reallyslow: 'Really Slow'
+			};
+
+			switchViewpointButton += '<div class="chooser leftchooser speedchooser"><em>Speed:</em><div>';
+			for (speed in speedTable) {
+				if (speedTable.hasOwnProperty(speed)) {
+					if (speed == this.speed)
+						switchViewpointButton += '<button value="' + speed + '" class="sel">' + speedTable[speed] + '</button>';
+					else
+						switchViewpointButton += '<button value="' + speed + '">' + speedTable[speed] + '</button>';
+				}
+			}
+			switchViewpointButton += '</div></div>';
+
+			var self = this;
+			this.$el.on('click', '.chooser button', function (e) {
+				self.speed = e.currentTarget.value
+				var $chooser = $(e.currentTarget).closest('.chooser');
+				var valueElem = $chooser.find('button[value=' + self.speed + ']');
+				$chooser.find('button').removeClass('sel');
+				valueElem.addClass('sel');
+
+				var delayTable = {
+					hyperfast: 1,
+					fast: 1,
+					normal: 1,
+					slow: 1000,
+					reallyslow: 3000
+				};
+				var fadeTable = {
+					hyperfast: 40,
+					fast: 50,
+					normal: 300,
+					slow: 500,
+					reallyslow: 1000
+				};
+
+				console.log(self.speed)
+				self.battle.messageShownTime = delayTable[self.speed];
+				self.battle.messageFadeTime = fadeTable[self.speed];
+				self.battle.scene.updateAcceleration();
+			});
+
 			if (this.battle.seeking !== null) {
 
 				// battle is seeking
diff --git a/play.pokemonshowdown.com/src/battle-animations-moves.ts b/play.pokemonshowdown.com/src/battle-animations-moves.ts
index cdae57c2..59b02888 100644
--- a/play.pokemonshowdown.com/src/battle-animations-moves.ts
+++ b/play.pokemonshowdown.com/src/battle-animations-moves.ts
@@ -712,7 +712,7 @@ export const BattleMoveAnims: AnimTable = {
 					time: 1550,
 				}, 'decel');
 			}
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-hail.png')`, 750, 1, 800);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-hail.png')`, 750, 1, 800);
 		},
 	},
 	sandstorm: {
@@ -1534,7 +1534,7 @@ export const BattleMoveAnims: AnimTable = {
 	orderup: {
 		anim(scene, [attacker, defender]) {
 			const tatsugiriSprite = {
-				url: `https://${Config.routes.client}/sprites/gen5/tatsugiri${['-droopy', '-stretchy', ''][Math.floor(Math.random() * 3)]}.png`,
+				url: `http://${window.location.host}/play.pokemonshowdown.com/sprites/gen5/tatsugiri${['-droopy', '-stretchy', ''][Math.floor(Math.random() * 3)]}.png`,
 				w: 96,
 				h: 96,
 			};
@@ -3611,7 +3611,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	morningsun: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sunnyday.jpg')`, 700, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sunnyday.jpg')`, 700, 0.5);
 			scene.showEffect('wisp', {
 				x: attacker.x + 40,
 				y: attacker.y - 40,
@@ -3664,7 +3664,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	moonlight: {
 		anim(scene, [attacker]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 800, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 800, 0.6);
 			scene.showEffect('moon', {
 				x: attacker.x,
 				y: attacker.y + 150,
@@ -3748,7 +3748,7 @@ export const BattleMoveAnims: AnimTable = {
 	lunarblessing: {
 		anim(scene, [attacker, ...defenders]) {
 			for (const defender of defenders) {
-				scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 900, 0.6);
+				scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 900, 0.6);
 				scene.showEffect('moon', {
 					x: attacker.x,
 					y: attacker.y + 150,
@@ -3872,7 +3872,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	cosmicpower: {
 		anim(scene, [attacker]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 600, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 600, 0.6);
 			scene.showEffect('wisp', {
 				x: attacker.x + 40,
 				y: attacker.y - 40,
@@ -5755,7 +5755,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	seismictoss: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 500, 0.6, 300);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 500, 0.6, 300);
 			scene.showEffect('wisp', {
 				x: defender.x,
 				y: defender.y + 10,
@@ -8587,7 +8587,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	meteormash: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 1000, 0.4);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 1000, 0.4);
 			scene.showEffect(attacker.sp, {
 				x: attacker.leftof(20),
 				y: attacker.y,
@@ -19199,7 +19199,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	psystrike: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-psychicterrain.png')`, 950, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-psychicterrain.png')`, 950, 0.6);
 			scene.showEffect('poisonwisp', {
 				x: defender.x - 100,
 				y: defender.y,
@@ -20061,7 +20061,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	moonblast: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 800, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 800, 0.6);
 			scene.showEffect('moon', {
 				x: attacker.x,
 				y: attacker.y,
@@ -20366,7 +20366,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	wish: {
 		anim(scene, [attacker]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 600, 0.4);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 600, 0.4);
 
 			scene.showEffect('wisp', {
 				x: attacker.x,
@@ -20380,7 +20380,7 @@ export const BattleMoveAnims: AnimTable = {
 			}, 'accel');
 		},
 		residualAnim(scene, [attacker]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 600, 0.4);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 600, 0.4);
 
 			scene.showEffect('wisp', {
 				x: attacker.x,
@@ -21629,7 +21629,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	dracometeor: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 1100, 0.8);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 1100, 0.8);
 			scene.showEffect('flareball', {
 				x: defender.leftof(-200),
 				y: defender.y + 175,
@@ -23143,7 +23143,7 @@ export const BattleMoveAnims: AnimTable = {
 			let ystep = (defender.x - 200 - attacker.x) / 5;
 			let zstep = (defender.z - attacker.z) / 5;
 
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sunnyday.jpg')`, 900, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sunnyday.jpg')`, 900, 0.5);
 
 			for (let i = 0; i < 5; i++) {
 				scene.showEffect('energyball', {
@@ -23502,7 +23502,7 @@ export const BattleMoveAnims: AnimTable = {
 			let ystep = 20;
 			let zstep = 0;
 
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sunnyday.jpg')`, 900, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sunnyday.jpg')`, 900, 0.5);
 
 			scene.showEffect('sword', {
 				x: attacker.leftof(10),
@@ -23787,7 +23787,7 @@ export const BattleMoveAnims: AnimTable = {
 			let ystep = (defender.x - 200 - attacker.x) / 5;
 			let zstep = (defender.z - attacker.z) / 5;
 
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sandstorm.png')`, 900, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sandstorm.png')`, 900, 0.5);
 
 			for (let i = 0; i < 5; i++) {
 				scene.showEffect('mudwisp', {
@@ -23987,7 +23987,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	sheercold: { // Reminder: Improve this later
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-icecave.jpg')`, 1000, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-icecave.jpg')`, 1000, 0.6);
 			scene.showEffect('icicle', {
 				x: defender.x,
 				y: defender.y,
@@ -24005,7 +24005,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	glaciallance: {
 		anim(scene, [attacker, ...defenders]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-icecave.jpg')`, 1000, 0.6);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-icecave.jpg')`, 1000, 0.6);
 			for (const defender of defenders) {
 				scene.showEffect('icicle', {
 					x: defender.x,
@@ -26320,7 +26320,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	dragonascent: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 1000, 0.7);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 1000, 0.7);
 			scene.showEffect('iceball', {
 				x: attacker.leftof(-25),
 				y: attacker.y + 250,
@@ -29811,7 +29811,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	plasmafists: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-earthycave.jpg')`, 2000, 1);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-earthycave.jpg')`, 2000, 1);
 			scene.backgroundEffect('#000000', 1000, 0.6);
 			scene.backgroundEffect('#FFFFFF', 300, 0.6, 1000);
 			scene.showEffect('electroball', {
@@ -30054,7 +30054,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	collisioncourse: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-sunnyday.jpg')`, 1300, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-sunnyday.jpg')`, 1300, 0.5);
 			scene.showEffect(attacker.sp, {
 				x: attacker.x,
 				y: attacker.y,
@@ -30200,7 +30200,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	electrodrift: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-electricterrain.png')`, 1300, 0.5);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-electricterrain.png')`, 1300, 0.5);
 			scene.showEffect(attacker.sp, {
 				x: attacker.x,
 				y: attacker.y,
@@ -34223,7 +34223,7 @@ export const BattleMoveAnims: AnimTable = {
 	oceanicoperetta: {
 		anim(scene, [attacker, defender]) {
 			scene.backgroundEffect('linear-gradient(#000000 20%, #0000DD)', 2700, 0.4);
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-raindance.jpg')`, 700, 0.2, 2000);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-raindance.jpg')`, 700, 0.2, 2000);
 			scene.showEffect('iceball', {
 				x: attacker.x,
 				y: attacker.y + 120,
@@ -34546,7 +34546,7 @@ export const BattleMoveAnims: AnimTable = {
 	},
 	splinteredstormshards: {
 		anim(scene, [attacker, defender]) {
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-earthycave.jpg')`, 2700, 0.8, 300);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-earthycave.jpg')`, 2700, 0.8, 300);
 			scene.backgroundEffect('linear-gradient(#FFC720 15%, #421800)', 2700, 0.7);
 			scene.backgroundEffect('#ffffff', 400, 0.6, 2500);
 			scene.showEffect('rock3', {
@@ -35269,7 +35269,7 @@ export const BattleMoveAnims: AnimTable = {
 			}
 			const defender = defenders[1] || defenders[0];
 			scene.backgroundEffect('#000000', 300, 0.9);
-			scene.backgroundEffect(`url('https://${Config.routes.client}/sprites/gen6bgs/bg-earthycave.jpg')`, 2000, 0.7, 300);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/sprites/gen6bgs/bg-earthycave.jpg')`, 2000, 0.7, 300);
 			scene.backgroundEffect('linear-gradient(#FB5C1E 20%, #3F1D0F', 2000, 0.6, 300);
 			scene.backgroundEffect('#FFFFFF', 1000, 0.9, 2200);
 			scene.showEffect('shine', {
@@ -35941,8 +35941,8 @@ export const BattleMoveAnims: AnimTable = {
 			let ystep = (defender.x - 200 - attacker.x) / 5;
 			let zstep = (defender.z - attacker.z) / 5;
 
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/weather-trickroom.png')`, 700, 1);
-			scene.backgroundEffect(`url('https://${Config.routes.client}/fx/bg-space.jpg')`, 2500, 1, 700);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/weather-trickroom.png')`, 700, 1);
+			scene.backgroundEffect(`url('http://${window.location.host}/play.pokemonshowdown.com/fx/bg-space.jpg')`, 2500, 1, 700);
 			scene.backgroundEffect('#FFFFFF', 1500, 1, 2500);
 
 			scene.showEffect('flareball', {
diff --git a/play.pokemonshowdown.com/src/battle-animations.ts b/play.pokemonshowdown.com/src/battle-animations.ts
index bf0f29c7..31e39fb0 100644
--- a/play.pokemonshowdown.com/src/battle-animations.ts
+++ b/play.pokemonshowdown.com/src/battle-animations.ts
@@ -204,6 +204,7 @@ export class BattleScene implements BattleSceneStub {
 
 		this.log.battleParser!.perspective = this.battle.mySide.sideid;
 
+		this.resetSideConditions();
 		this.resetSides(true);
 	}
 
diff --git a/play.pokemonshowdown.com/src/battle-dex.ts b/play.pokemonshowdown.com/src/battle-dex.ts
index 03910cf4..765fb579 100644
--- a/play.pokemonshowdown.com/src/battle-dex.ts
+++ b/play.pokemonshowdown.com/src/battle-dex.ts
@@ -229,16 +229,9 @@ export const Dex = new class implements ModdedDex {
 
 	pokeballs: string[] | null = null;
 
-	resourcePrefix = (() => {
-		let prefix = '';
-		if (window.document?.location?.protocol !== 'http:') prefix = 'https:';
-		return `${prefix}//${window.Config ? Config.routes.client : 'play.pokemonshowdown.com'}/`;
-	})();
-
-	fxPrefix = (() => {
-		const protocol = (window.document?.location?.protocol !== 'http:') ? 'https:' : '';
-		return `${protocol}//${window.Config ? Config.routes.client : 'play.pokemonshowdown.com'}/fx/`;
-	})();
+	resourcePrefix = `http://${window.location.host}/play.pokemonshowdown.com/`;
+
+	fxPrefix = `http://${window.location.host}/play.pokemonshowdown.com/fx/`;
 
 	loadedSpriteData = { xy: 1, bw: 0 };
 	moddedDexes: { [mod: string]: ModdedDex } = {};
diff --git a/play.pokemonshowdown.com/src/battle-sound.ts b/play.pokemonshowdown.com/src/battle-sound.ts
index f7104379..cbd85c08 100644
--- a/play.pokemonshowdown.com/src/battle-sound.ts
+++ b/play.pokemonshowdown.com/src/battle-sound.ts
@@ -116,7 +116,7 @@ export const BattleSound = new class {
 		if (this.soundCache[url]) return this.soundCache[url];
 		try {
 			const sound = document.createElement('audio');
-			sound.src = `https://${Config.routes.client}/${url}`;
+			sound.src = `http://${window.location.host}/play.pokemonshowdown.com/` + url;
 			sound.volume = this.effectVolume / 100;
 			this.soundCache[url] = sound;
 			return sound;
diff --git a/play.pokemonshowdown.com/style/battle.css b/play.pokemonshowdown.com/style/battle.css
index bf8bed31..2eac7e49 100644
--- a/play.pokemonshowdown.com/style/battle.css
+++ b/play.pokemonshowdown.com/style/battle.css
@@ -628,6 +628,7 @@ License: GPLv2
 }
 .leftchooser {
 	float: left;
+	margin: 5px 0 0 10px;
 }
 .chooser em {
 	float: left;
@@ -636,6 +637,7 @@ License: GPLv2
 	border-right: 1px solid #CCCCCC;
 	background: #EEEEEE;
 	font-weight: normal;
+	color: #000000;
 }
 .chooser div {
 	float: left;
diff --git a/play.pokemonshowdown.com/testclient.html b/play.pokemonshowdown.com/testclient.html
index e17d44c0..3539a30b 100644
--- a/play.pokemonshowdown.com/testclient.html
+++ b/play.pokemonshowdown.com/testclient.html
@@ -110,7 +110,8 @@
 		<script src="js/client-battle.js"></script>
 		<script src="js/client-rooms.js"></script>
 		<script src="js/storage.js"></script>
-		<script src="data/graphics.js" onerror="loadRemoteData(this.src)"></script>
+		<script src="js/battle-animations.js"></script>
+		<script src="js/battle-animations-moves.js"></script>
 
 		<script src="data/pokedex.js" onerror="loadRemoteData(this.src)"></script>
 		<script src="data/moves.js" onerror="loadRemoteData(this.src)"></script>
-- 
2.45.1.windows.1

